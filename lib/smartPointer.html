
<!DOCTYPE html>
<html lang="bg">
<head>
    <title>Умни указатели</title>
    <meta charset="UTF-8">
    <meta name="keywords" content="rust,fmi">
    <link rel="stylesheet" href="resources/codeblock/codeblock.css">
<link rel="stylesheet" href="resources/frontend/controls.css">
<link rel="stylesheet" href="resources/global/global.css">
<link rel="stylesheet" href="resources/global/metadata.css">
<link rel="stylesheet" href="resources/highlight/hljs-github.css">
<link rel="stylesheet" href="resources/highlight/style.css">
<link rel="stylesheet" href="resources/highlight/tshl-github.css">
<link rel="stylesheet" href="resources/katex/katex.min.css">
<link rel="stylesheet" href="resources/rustc/rustc.css">
<link rel="stylesheet" href="resources/splitview/splitview.css">
<link rel="stylesheet" href="resources/wrapping-pages/wrapping-pages.css">
<script type="text/javascript" src="resources/codeblock/codeblock.js"></script>
<script type="text/javascript" src="resources/frontend/controls.js"></script>
</head>
<body>
    <main>
        <div class="slide">
<h1 id="умни-указатели">Умни указатели</h1>
<h3 id="09-ноември-2021">09 ноември 2021</h3>
</div><div class="slide">
<h1 id="преговор">Преговор</h1>
</div><div class="slide subslide">
<h1 id="преговор">Преговор</h1>
<ul>
<li>Често срещани trait-ове (<code>Copy</code>, <code>Drop</code>, <code>Display</code>/<code>Debug</code> и т.н.)</li>
</ul>
</div><div class="slide subslide">
<h1 id="преговор">Преговор</h1>
<ul>
<li>Често срещани trait-ове (<code>Copy</code>, <code>Drop</code>, <code>Display</code>/<code>Debug</code> и т.н.)</li>
<li>предефиниране на оператори (<code>PartialEq</code>/<code>Eq</code>, <code>PartialOrd</code>/<code>Ord</code> и други)</li>
</ul>
</div><div class="slide subslide">
<h1 id="преговор">Преговор</h1>
<ul>
<li>Често срещани trait-ове (<code>Copy</code>, <code>Drop</code>, <code>Display</code>/<code>Debug</code> и т.н.)</li>
<li>предефиниране на оператори (<code>PartialEq</code>/<code>Eq</code>, <code>PartialOrd</code>/<code>Ord</code> и други)</li>
<li>Iterator (for-цикли, адаптери)</li>
</ul>
</div><div class="slide subslide">
<h1 id="преговор">Преговор</h1>
<ul>
<li>Често срещани trait-ове (<code>Copy</code>, <code>Drop</code>, <code>Display</code>/<code>Debug</code> и т.н.)</li>
<li>предефиниране на оператори (<code>PartialEq</code>/<code>Eq</code>, <code>PartialOrd</code>/<code>Ord</code> и други)</li>
<li>Iterator (for-цикли, адаптери)</li>
<li>Closures (анонимни функции и още нещо!)</li>
</ul>
</div><div class="slide subslide">
<h1 id="преговор">Преговор</h1>
<ul>
<li>Често срещани trait-ове (<code>Copy</code>, <code>Drop</code>, <code>Display</code>/<code>Debug</code> и т.н.)</li>
<li>предефиниране на оператори (<code>PartialEq</code>/<code>Eq</code>, <code>PartialOrd</code>/<code>Ord</code> и други)</li>
<li>Iterator (for-цикли, адаптери)</li>
<li>Closures (анонимни функции и още нещо!)</li>
<li>Fn trait-ове (когато искаме да подаваме closures на функции)</li>
</ul>
</div><div class="slide">
<h1 id="малък-тест">Малък тест</h1>
<ul>
<li>Ограничен до 2 минути</li>
</ul>
</div><div class="slide subslide">
<h1 id="малък-тест">Малък тест</h1>
<ul>
<li>Ограничен до 2 минути</li>
<li>С бонус, но без наказателни точки</li>
</ul>
</div><div class="slide subslide">
<h1 id="малък-тест">Малък тест</h1>
<ul>
<li>Ограничен до 2 минути</li>
<li>С бонус, но без наказателни точки</li>
<li>Можете да ползвате всякаква информация, но само първите верни съждения получават точки</li>
</ul>
</div><div class="slide subslide">
<h1 id="малък-тест">Малък тест</h1>
<ul>
<li>Ограничен до 2 минути</li>
<li>С бонус, но без наказателни точки</li>
<li>Можете да ползвате всякаква информация, но само първите верни съждения получават точки</li>
<li>Теста е и като обратна връзка за нас</li>
</ul>
</div><div class="slide subslide">
<h1 id="малък-тест">Малък тест</h1>
<ul>
<li>Ограничен до 2 минути</li>
<li>С бонус, но без наказателни точки</li>
<li>Можете да ползвате всякаква информация, но само първите верни съждения получават точки</li>
<li>Теста е и като обратна връзка за нас</li>
<li>Какви са приликите и разликите между trait-овете <code>Copy</code> и <code>Clone</code>.</li>
</ul>
</div><div class="slide subslide">
<h1 id="малък-тест">Малък тест</h1>
<ul>
<li>Ограничен до 2 минути</li>
<li>С бонус, но без наказателни точки</li>
<li>Можете да ползвате всякаква информация, но само първите верни съждения получават точки</li>
<li>Теста е и като обратна връзка за нас</li>
<li>Какви са приликите и разликите между trait-овете <code>Copy</code> и <code>Clone</code>.</li>
</ul>
</div><div class="slide">
<h1 id="smart-pointers">Smart pointers</h1>
<p><a target="_blank" href="https://docs.google.com/presentation/d/1q-c7UAyrUlM-eZyTo1pd8SZ0qwA_wYxmPZVOQkoDmH4/edit">
    <img src="resources/container_cheat_sheet.svg" height="500px" />
</a></p>
</div><div class="slide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<ul>
<li><code>Sized</code> е ✨магически✨ trait</li>
</ul>
</div><div class="slide subslide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<ul>
<li><code>Sized</code> е ✨магически✨ trait</li>
<li>Имплементира се автоматично от типове, чиито размер се знае at compile-time</li>
</ul>
</div><div class="slide subslide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<ul>
<li><code>Sized</code> е ✨магически✨ trait</li>
<li>Имплементира се автоматично от типове, чиито размер се знае at compile-time</li>
<li>Примерно: <code>u8</code>, <code>Vec&lt;T&gt;</code>, <code>&amp;T</code></li>
</ul>
</div><div class="slide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<ul>
<li>Типове, които не са <code>Sized</code>: <code>[T]</code>, <code>dyn Trait</code>, <code>str</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<ul>
<li>Типове, които не са <code>Sized</code>: <code>[T]</code>, <code>dyn Trait</code>, <code>str</code></li>
<li>Винаги стоят зад някакъв pointer/reference: <code>&amp;[T]</code>, <code>&amp;dyn Trait</code>, <code>&amp;str</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<ul>
<li>Типове, които не са <code>Sized</code>: <code>[T]</code>, <code>dyn Trait</code>, <code>str</code></li>
<li>Винаги стоят зад някакъв pointer/reference: <code>&amp;[T]</code>, <code>&amp;dyn Trait</code>, <code>&amp;str</code></li>
<li>Reference-а в този случай е "fat pointer", който държи не само указател, но и размера на парчето данни, което има този тип.</li>
</ul>
</div><div class="slide subslide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<ul>
<li>Типове, които не са <code>Sized</code>: <code>[T]</code>, <code>dyn Trait</code>, <code>str</code></li>
<li>Винаги стоят зад някакъв pointer/reference: <code>&amp;[T]</code>, <code>&amp;dyn Trait</code>, <code>&amp;str</code></li>
<li>Reference-а в този случай е "fat pointer", който държи не само указател, но и размера на парчето данни, което има този тип.</li>
<li>Забележете, че <code>[u32]</code> не е <code>Sized</code>, но <code>[u32; 5]</code> е. Защото размера на данните се съдържа в конкретния тип.</li>
</ul>
</div><div class="slide">
<h1 id="sized-"><code>?Sized</code> ???</h1>
<p><code>?Sized</code> означава, че типа <strong>не е нужно</strong> да имплементира Sized.</p>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-comment">// Използваем само с тип, който имплементира Sized:</span>
<span class="tshl-keyword">fn</span> <span class="tshl-function">foo</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {}

<span class="tshl-comment">// Използваем с тип, който *може* да имплементира Sized,</span>
<span class="tshl-comment">// но не е *нужно*:</span>
<span class="tshl-keyword">fn</span> <span class="tshl-function">bar</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span>: ?<span class="tshl-type">Sized</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {}</code></pre>
                    </div>
                    
                </div>
                
<p>Особено ограничение, понеже <em>разширява</em> броя типове, които могат да се приемат, вместо да го стеснява.</p>
<p>Защо? Защото ако една стойност не е Sized, компилатора не може да я алокира на стека. Така че е доста добра идея да присъства като автоматичен trait bound.</p>
</div><div class="slide">
<h1 id="sized-"><code>?Sized</code> ???</h1>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">foo</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">t</span>: <span class="tshl-type">T</span><span class="tshl-punctuation_bracket">)</span> {}            <span class="tshl-comment">// -&gt; totally fine, T е Sized</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">bar</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span>: ?<span class="tshl-type">Sized</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">t</span>: <span class="tshl-operator">&amp;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">)</span> {}   <span class="tshl-comment">// -&gt; totally fine, &amp;T е Sized</span>

<span class="tshl-comment">// fn bar&lt;T: ?Sized&gt;(t: T) {} // -&gt; невъзможно, защото как ще се алокира t?</span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="smart-pointers">Smart pointers</h1>
</div><div class="slide">
<h1 id="t">&amp;T</h1>
<p>Най-глупавия указател, но важен за целите на сравнението</p>
<p><img src="resources/reference.png" /></p>
</div><div class="slide">
<h1 id="t">&amp;T</h1>
<ul>
<li>Най-простия начин да реферираме към памет, където и да е в паметта (който не изисква <code>unsafe</code>)</li>
</ul>
</div><div class="slide subslide">
<h1 id="t">&amp;T</h1>
<ul>
<li>Най-простия начин да реферираме към памет, където и да е в паметта (който не изисква <code>unsafe</code>)</li>
<li>Няма ownership -- нещо друго трябва да е owner на тази памет</li>
</ul>
</div><div class="slide subslide">
<h1 id="t">&amp;T</h1>
<ul>
<li>Най-простия начин да реферираме към памет, където и да е в паметта (който не изисква <code>unsafe</code>)</li>
<li>Няма ownership -- нещо друго трябва да е owner на тази памет</li>
<li>Нужда от жонглиране на lifetimes</li>
</ul>
</div><div class="slide subslide">
<h1 id="t">&amp;T</h1>
<ul>
<li>Най-простия начин да реферираме към памет, където и да е в паметта (който не изисква <code>unsafe</code>)</li>
<li>Няма ownership -- нещо друго трябва да е owner на тази памет</li>
<li>Нужда от жонглиране на lifetimes</li>
<li>Позволяват изключителна ефективност</li>
</ul>
</div><div class="slide">
<h1 id="t">&amp;T</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="f6a929d7f5e1f889c6c586f6ca85c1d1e21653a9">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> potato = <span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;</span>
<span class="tshl-string">    Любов, любов, варен картоф,</span>
<span class="tshl-string">    разрежеш го, а той суров.</span>
<span class="tshl-string">&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">let</span> lines = potato<span class="tshl-punctuation_delimiter">.</span>
    <span class="tshl-function_method">trim</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">.</span>
    <span class="tshl-function_method">lines</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">.</span>
    <span class="tshl-function_method">map</span><span class="tshl-punctuation_bracket">(</span>|l| l<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">trim</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">for</span> line <span class="tshl-keyword">in</span> lines {
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, line<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">Любов, любов, варен картоф,
разрежеш го, а той суров.</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="f6a929d7f5e1f889c6c586f6ca85c1d1e21653a9">fn main() {
let potato = String::from("
    Любов, любов, варен картоф,
    разрежеш го, а той суров.
");

let lines = potato.
    trim().
    lines().
    map(|l| l.trim());

for line in lines {
    println!("{}", line);
}
}</pre>
<p>В горния пример има само алокация на първия <code>String</code>, останалите методи -- <code>trim</code>, <code>lines</code>, <code>map</code>, само алокират малки стойности на стека.</p>
</div><div class="slide">
<h1 id="box">Box</h1>
<p>Reference + ownership!</p>
<p><img src="resources/box.png" /></p>
</div><div class="slide">
<h1 id="box">Box</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="7bd36252555ac28464cdf89d4166c3b0a9ffe91f">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> b = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;b = {}&quot;</span>, b<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">b = 5</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="7bd36252555ac28464cdf89d4166c3b0a9ffe91f">fn main() {
    let b = Box::new(5);
    println!("b = {}", b);
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<ul>
<li>Също прост -- сочи към парцал памет, само и единствено в heap-а</li>
</ul>
</div><div class="slide subslide">
<h1 id="box">Box</h1>
<ul>
<li>Също прост -- сочи към парцал памет, само и единствено в heap-а</li>
<li>Има ownership, което значи, че няма нужда да се грижим за lifetimes</li>
</ul>
</div><div class="slide subslide">
<h1 id="box">Box</h1>
<ul>
<li>Също прост -- сочи към парцал памет, само и единствено в heap-а</li>
<li>Има ownership, което значи, че няма нужда да се грижим за lifetimes</li>
<li>(Но алокира нова стойност на heap-а, така че не позволява ефективността на гол reference.)</li>
</ul>
</div><div class="slide subslide">
<h1 id="box">Box</h1>
<ul>
<li>Също прост -- сочи към парцал памет, само и единствено в heap-а</li>
<li>Има ownership, което значи, че няма нужда да се грижим за lifetimes</li>
<li>(Но алокира нова стойност на heap-а, така че не позволява ефективността на гол reference.)</li>
<li>Донякъде магически -- няма как да си направим наш <code>Box</code>, защото няма как да укажем на компилатора "алокирай това на heap-а".</li>
</ul>
</div><div class="slide subslide">
<h1 id="box">Box</h1>
<ul>
<li>Също прост -- сочи към парцал памет, само и единствено в heap-а</li>
<li>Има ownership, което значи, че няма нужда да се грижим за lifetimes</li>
<li>(Но алокира нова стойност на heap-а, така че не позволява ефективността на гол reference.)</li>
<li>Донякъде магически -- няма как да си направим наш <code>Box</code>, защото няма как да укажем на компилатора "алокирай това на heap-а".</li>
<li>Много условно казано, горе-долу, донякъде, може да си представите, че:</li>
<li><code>String</code> ~~ <code>Box&lt;str&gt;</code></li>
<li><code>Vec&lt;T&gt;</code> ~~ <code>Box&lt;[T]&gt;</code></li>
</ul>
</div><div class="slide">
<h1 id="box">Box</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="81c11fbe09e1559f40de38f65b4627444769a9b5">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> x = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> y = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, x + y<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs"><span style="font-weight:bold;color:rgb(255,85,85)">error[E0369]</span><span style="font-weight:bold">: cannot add `Box&lt;{integer}&gt;` to `Box&lt;{integer}&gt;`</span>
 <span style="font-weight:bold;color:rgb(85,85,255)">--&gt; </span>src/bin/main_81c11fbe09e1559f40de38f65b4627444769a9b5.rs:5:22
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">5</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    println!("{}", x + y);
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>                   <span style="font-weight:bold;color:rgb(85,85,255)">-</span> <span style="font-weight:bold;color:rgb(255,85,85)">^</span> <span style="font-weight:bold;color:rgb(85,85,255)">-</span> <span style="font-weight:bold;color:rgb(85,85,255)">Box&lt;{integer}&gt;</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>                   <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>                   <span style="font-weight:bold;color:rgb(85,85,255)">Box&lt;{integer}&gt;</span>

<span style="font-weight:bold">For more information about this error, try `rustc --explain E0369`.</span>
<span style="font-weight:bold;color:rgb(255,85,85)">error</span><span style="font-weight:bold">:</span> could not compile `rust` due to previous error</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="81c11fbe09e1559f40de38f65b4627444769a9b5">fn main() {
    let x = Box::new(3);
    let y = Box::new(5);

    println!("{}", x + y);
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="a91cefc85b6645a7267b69b26e347ccf03840209">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> x = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> y = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, *x + *y<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-keyword">let</span> x = <span class="tshl-operator">&amp;</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> y = <span class="tshl-operator">&amp;</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, *x + *y<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">8
8</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="a91cefc85b6645a7267b69b26e347ccf03840209">fn main() {
    let x = Box::new(3);
    let y = Box::new(5);

    println!("{}", *x + *y);

    let x = &3;
    let y = &5;

    println!("{}", *x + *y);
}</pre>
<p>(Note: not magic)</p>
</div><div class="slide">
<h1 id="box">Box</h1>
<p>А за какво ни е всъщност?</p>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="linked-list">Linked list</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>derive<span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Debug</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-keyword">enum</span> <span class="tshl-type">List</span> {
    <span class="tshl-constructor">Nil</span>,
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">i32</span>, <span class="tshl-type">List</span><span class="tshl-punctuation_bracket">)</span>,
}

<span class="tshl-keyword">use</span> <span class="tshl-constructor">List</span><span class="tshl-punctuation_delimiter">::</span>{<span class="tshl-constructor">Cons</span>, <span class="tshl-constructor">Nil</span>}<span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> list = <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span>, <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span>, <span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:#?}&quot;</span>, list<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="box">Box</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="8ba92f92a6708ff40e65364f4344a56ecfa46195">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>derive<span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Debug</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-keyword">enum</span> <span class="tshl-type">List</span> {
    <span class="tshl-constructor">Nil</span>,
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">i32</span>, <span class="tshl-type">List</span><span class="tshl-punctuation_bracket">)</span>,
}

<span class="tshl-keyword">use</span> <span class="tshl-constructor">List</span><span class="tshl-punctuation_delimiter">::</span>{<span class="tshl-constructor">Cons</span>, <span class="tshl-constructor">Nil</span>}<span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> list = <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span>, <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span>, <span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:#?}&quot;</span>, list<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs"><span style="font-weight:bold;color:rgb(255,85,85)">error[E0072]</span><span style="font-weight:bold">: recursive type `List` has infinite size</span>
 <span style="font-weight:bold;color:rgb(85,85,255)">--&gt; </span>src/bin/main_8ba92f92a6708ff40e65364f4344a56ecfa46195.rs:2:1
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">2</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>enum List {
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span><span style="font-weight:bold;color:rgb(255,85,85)">^^^^^^^^^</span> <span style="font-weight:bold;color:rgb(255,85,85)">recursive type has infinite size</span>
<span style="font-weight:bold;color:rgb(85,85,255)">3</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    Nil,
<span style="font-weight:bold;color:rgb(85,85,255)">4</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    Cons(i32, List),
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>              <span style="font-weight:bold;color:rgb(85,85,255)">----</span> <span style="font-weight:bold;color:rgb(85,85,255)">recursive without indirection</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,187,187)">help</span>: insert some indirection (e.g., a `Box`, `Rc`, or `&amp;`) to make `List` representable
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">4</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    Cons(i32, <span style="color:rgb(85,187,85)">Box&lt;</span>List<span style="color:rgb(85,187,85)">&gt;</span>),
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>              <span style="color:rgb(85,187,85)">++++</span>    <span style="color:rgb(85,187,85)">+</span>

<span style="font-weight:bold;color:rgb(255,85,85)">error[E0391]</span><span style="font-weight:bold">: cycle detected when computing drop-check constraints for `List`</span>
 <span style="font-weight:bold;color:rgb(85,85,255)">--&gt; </span>src/bin/main_8ba92f92a6708ff40e65364f4344a56ecfa46195.rs:2:1
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">2</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>enum List {
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span><span style="font-weight:bold;color:rgb(255,85,85)">^^^^^^^^^</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">= </span><span style="font-weight:bold">note</span>: ...which immediately requires computing drop-check constraints for `List` again
  <span style="font-weight:bold;color:rgb(85,85,255)">= </span><span style="font-weight:bold">note</span>: cycle used when computing dropck types for `Canonical { max_universe: U0, variables: [], value: ParamEnvAnd { param_env: ParamEnv { caller_bounds: [], reveal: UserFacing }, value: List } }`

<span style="font-weight:bold">Some errors have detailed explanations: E0072, E0391.</span>
<span style="font-weight:bold">For more information about an error, try `rustc --explain E0072`.</span>
<span style="font-weight:bold;color:rgb(255,85,85)">error</span><span style="font-weight:bold">:</span> could not compile `rust` due to 2 previous errors</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="8ba92f92a6708ff40e65364f4344a56ecfa46195">#[derive(Debug)]
enum List {
    Nil,
    Cons(i32, List),
}

use List::{Cons, Nil};

fn main() {
    let list = Cons(1, Cons(2, Cons(3, Nil)));

    println!("{:#?}", list);
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="87244ab679df9039df18d2d14e47d2e83139c5ab">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>derive<span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Debug</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-keyword">enum</span> <span class="tshl-type">List</span> {
    <span class="tshl-constructor">Nil</span>,
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">i32</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">List</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span>,
}

<span class="tshl-keyword">use</span> <span class="tshl-constructor">List</span><span class="tshl-punctuation_delimiter">::</span>{<span class="tshl-constructor">Cons</span>, <span class="tshl-constructor">Nil</span>}<span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> list = <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, list<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">Cons(1, Cons(2, Cons(3, Nil)))</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="87244ab679df9039df18d2d14e47d2e83139c5ab">#[derive(Debug)]
enum List {
    Nil,
    Cons(i32, Box<List>),
}

use List::{Cons, Nil};

fn main() {
    let list = Cons(1, Box::new(Cons(2, Box::new(Cons(3, Box::new(Nil))))));
    println!("{:?}", list);
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<p>Можем ли вместо <code>Box</code> да ползваме <code>&amp;</code>? Kinda:</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="6ee7253f70e65a25fbe00719ff12fdafeb35cfa3">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>derive<span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Debug</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-keyword">enum</span> <span class="tshl-type">List</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-constructor">Nil</span>,
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">i32</span>, <span class="tshl-operator">&amp;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span> <span class="tshl-type">List</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span>,
}

<span class="tshl-keyword">use</span> <span class="tshl-constructor">List</span><span class="tshl-punctuation_delimiter">::</span>{<span class="tshl-constructor">Cons</span>, <span class="tshl-constructor">Nil</span>}<span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> list = <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-operator">&amp;</span><span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span>, <span class="tshl-operator">&amp;</span><span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, list<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">Cons(1, Cons(2, Nil))</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="6ee7253f70e65a25fbe00719ff12fdafeb35cfa3">#[derive(Debug)]
enum List<'a> {
    Nil,
    Cons(i32, &'a List<'a>),
}

use List::{Cons, Nil};

fn main() {
    let list = Cons(1, &Cons(2, &Nil));

    println!("{:?}", list);
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<p>Това работи, но не можем да местим тази стойност:</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="567d155504aa95d3cfd7da212db462492777c6d6">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>derive<span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Debug</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-keyword">enum</span> <span class="tshl-type">List</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-constructor">Nil</span>,
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">i32</span>, <span class="tshl-operator">&amp;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span> <span class="tshl-type">List</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span>,
}

<span class="tshl-keyword">use</span> <span class="tshl-constructor">List</span><span class="tshl-punctuation_delimiter">::</span>{<span class="tshl-constructor">Cons</span>, <span class="tshl-constructor">Nil</span>}<span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">return_list</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">x</span>: <span class="tshl-type_builtin">i32</span>, <span class="tshl-variable_parameter">y</span>: <span class="tshl-type_builtin">i32</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">List</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span>x, <span class="tshl-operator">&amp;</span><span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span>y, <span class="tshl-operator">&amp;</span><span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, return_list<span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-constant_builtin">2</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs"><span style="font-weight:bold;color:rgb(255,85,85)">error[E0515]</span><span style="font-weight:bold">: cannot return value referencing temporary value</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">--&gt; </span>src/bin/main_567d155504aa95d3cfd7da212db462492777c6d6.rs:10:5
   <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">10</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    Cons(x, &amp;Cons(y, &amp;Nil))
   <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">^^^^^^^^^</span><span style="font-weight:bold;color:rgb(85,85,255)">-------------</span><span style="font-weight:bold;color:rgb(255,85,85)">^</span>
   <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">|</span>        <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
   <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">|</span>        <span style="font-weight:bold;color:rgb(85,85,255)">temporary value created here</span>
   <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">returns a value referencing data owned by the current function</span>

<span style="font-weight:bold">For more information about this error, try `rustc --explain E0515`.</span>
<span style="font-weight:bold;color:rgb(255,85,85)">error</span><span style="font-weight:bold">:</span> could not compile `rust` due to previous error</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="567d155504aa95d3cfd7da212db462492777c6d6">#[derive(Debug)]
enum List<'a> {
    Nil,
    Cons(i32, &'a List<'a>),
}

use List::{Cons, Nil};

fn return_list<'a>(x: i32, y: i32) -> List<'a> {
    Cons(x, &Cons(y, &Nil))
}

fn main() {
    println!("{:?}", return_list(1, 2));
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<p>Никакъв проблем ако ползваме <code>Box</code>, защото <code>Cons(1, Box::new(...))</code> си държи ownership:</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="0b91dbe7ed58f7dc8dea980ca6743b9edc736433">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>derive<span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Debug</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-keyword">enum</span> <span class="tshl-type">List</span> {
    <span class="tshl-constructor">Nil</span>,
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">i32</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">List</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span>,
}

<span class="tshl-keyword">use</span> <span class="tshl-constructor">List</span><span class="tshl-punctuation_delimiter">::</span>{<span class="tshl-constructor">Cons</span>, <span class="tshl-constructor">Nil</span>}<span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">return_list</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">x</span>: <span class="tshl-type_builtin">i32</span>, <span class="tshl-variable_parameter">y</span>: <span class="tshl-type_builtin">i32</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">List</span> {
    <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span>x, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span>y, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, return_list<span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-constant_builtin">2</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">Cons(1, Cons(2, Nil))</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="0b91dbe7ed58f7dc8dea980ca6743b9edc736433">#[derive(Debug)]
enum List {
    Nil,
    Cons(i32, Box<List>),
}

use List::{Cons, Nil};

fn return_list(x: i32, y: i32) -> List {
    Cons(x, Box::new(Cons(y, Box::new(Nil))))
}

fn main() {
    println!("{:?}", return_list(1, 2));
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="trait-objects-преговор">Trait objects (преговор)</h3>
<p>Ако имаме trait <code>Stuff</code>, <code>&amp;dyn Stuff</code> представлява какъвто и да е обект имплементиращ trait-а.</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="8708ec4f6cd97b58af5669aefc7d25c10289c5f8">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">to_json</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">value</span>: <span class="tshl-operator">&amp;</span><span class="tshl-keyword">dyn</span> <span class="tshl-type">ToJson</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">String</span> {
    value<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">to_json</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span>
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> trait_object: <span class="tshl-operator">&amp;</span><span class="tshl-keyword">dyn</span> <span class="tshl-type">ToJson</span> = <span class="tshl-operator">&amp;</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, to_json<span class="tshl-punctuation_bracket">(</span>trait_object<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, to_json<span class="tshl-punctuation_bracket">(</span>&amp;<span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, to_json<span class="tshl-punctuation_bracket">(</span>&amp;<span class="tshl-constant_builtin">5</span> <span class="tshl-operator">as</span> &amp;dyn <span class="tshl-constructor">ToJson</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">5
5
5</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="8708ec4f6cd97b58af5669aefc7d25c10289c5f8">trait ToJson { fn to_json(&self) -> String; }
impl ToJson for i32 {
fn to_json(&self) -> String {
format!("{}", self)
}
}
fn to_json(value: &dyn ToJson) -> String {
    value.to_json()
}

fn main() {
    let trait_object: &dyn ToJson = &5;

    println!("{}", to_json(trait_object));
    println!("{}", to_json(&5));
    println!("{}", to_json(&5 as &dyn ToJson));
}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="trait-objects-преговор">Trait objects (преговор)</h3>
<ul>
<li>Един указател към конкретна стойност в паметта</li>
</ul>
</div><div class="slide subslide">
<h1 id="box">Box</h1>
<h3 id="trait-objects-преговор">Trait objects (преговор)</h3>
<ul>
<li>Един указател към конкретна стойност в паметта</li>
<li>Още един указател към "виртуална таблица" (vtable), която указва кой метод да се извика</li>
</ul>
</div><div class="slide subslide">
<h1 id="box">Box</h1>
<h3 id="trait-objects-преговор">Trait objects (преговор)</h3>
<ul>
<li>Един указател към конкретна стойност в паметта</li>
<li>Още един указател към "виртуална таблица" (vtable), която указва кой метод да се извика</li>
<li>"Dynamic dispatch" - в C++ това се постига с виртуални методи</li>
</ul>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="trait-objects">Trait objects</h3>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="6ccf239cdd09201f91ae142543011bacb499f05c">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">vec_of_things</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&amp;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span> <span class="tshl-keyword">dyn</span> <span class="tshl-type">Display</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-keyword">let</span> x = <span class="tshl-constant_builtin">123</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">vec</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">[</span>&amp;x, &amp;<span class="tshl-constant_builtin">3.14</span>, &amp;<span class="tshl-string">&quot;foobar&quot;</span><span class="tshl-punctuation_bracket">]</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs"><span style="font-weight:bold;color:rgb(255,85,85)">error[E0515]</span><span style="font-weight:bold">: cannot return value referencing local variable `x`</span>
 <span style="font-weight:bold;color:rgb(85,85,255)">--&gt; </span>src/bin/main_6ccf239cdd09201f91ae142543011bacb499f05c.rs:4:5
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">4</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    vec![&amp;x, &amp;3.14, &amp;"foobar"]
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">^^^^^</span><span style="font-weight:bold;color:rgb(85,85,255)">--</span><span style="font-weight:bold;color:rgb(255,85,85)">^^^^^^^^^^^^^^^^^^^</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">|</span>    <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">|</span>    <span style="font-weight:bold;color:rgb(85,85,255)">`x` is borrowed here</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>    <span style="font-weight:bold;color:rgb(255,85,85)">returns a value referencing data owned by the current function</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">= </span><span style="font-weight:bold">note</span>: this error originates in the macro `vec` (in Nightly builds, run with -Z macro-backtrace for more info)

<span style="font-weight:bold">For more information about this error, try `rustc --explain E0515`.</span>
<span style="font-weight:bold;color:rgb(255,85,85)">error</span><span style="font-weight:bold">:</span> could not compile `rust` due to previous error</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="6ccf239cdd09201f91ae142543011bacb499f05c">use std::fmt::Display;
fn vec_of_things<'a>() -> Vec<&'a dyn Display> {
    let x = 123;
    vec![&x, &3.14, &"foobar"]
}
fn main() {}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="trait-objects">Trait objects</h3>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="3e00bbfafde31f103e4133bcc22af5f71cf193d8">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">vec_of_things</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-keyword">dyn</span> <span class="tshl-type">Display</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-keyword">let</span> x = <span class="tshl-constant_builtin">123</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">vec</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-constructor">Box</span>::new<span class="tshl-punctuation_bracket">(</span>x<span class="tshl-punctuation_bracket">)</span>, <span class="tshl-constructor">Box</span>::new<span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3.14</span><span class="tshl-punctuation_bracket">)</span>, <span class="tshl-constructor">Box</span>::new<span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;foobar&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span>
}</code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="3e00bbfafde31f103e4133bcc22af5f71cf193d8">#![allow(dead_code)]
use std::fmt::Display;
fn vec_of_things() -> Vec<Box<dyn Display>> {
    let x = 123;
    vec![Box::new(x), Box::new(3.14), Box::new("foobar")]
}
fn main() {}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<p><code>Box&lt;Error&gt;</code> -- ако ни мързи да правим error handling</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="5d561ab95e9ae803187dbf2e42b7f0dd8c3446d6">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">get_x</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Result</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">i32</span>, std<span class="tshl-punctuation_delimiter">::</span>io<span class="tshl-punctuation_delimiter">::</span><span class="tshl-type">Error</span><span class="tshl-punctuation_bracket">&gt;</span> { <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">)</span> }
<span class="tshl-keyword">fn</span> <span class="tshl-function">get_y</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Result</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">i32</span>, std<span class="tshl-punctuation_delimiter">::</span>fmt<span class="tshl-punctuation_delimiter">::</span><span class="tshl-type">Error</span><span class="tshl-punctuation_bracket">&gt;</span> { <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span> }

<span class="tshl-keyword">fn</span> <span class="tshl-function">foo</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Result</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">i32</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-keyword">dyn</span> std<span class="tshl-punctuation_delimiter">::</span>error<span class="tshl-punctuation_delimiter">::</span><span class="tshl-type">Error</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-keyword">let</span> x = <span class="tshl-function">get_x</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span>?<span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> y = <span class="tshl-function">get_y</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span>?<span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span>x + y<span class="tshl-punctuation_bracket">)</span>
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, foo<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">Ok(8)</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="5d561ab95e9ae803187dbf2e42b7f0dd8c3446d6">fn get_x() -> Result<i32, std::io::Error> { Ok(3) }
fn get_y() -> Result<i32, std::fmt::Error> { Ok(5) }

fn foo() -> Result<i32, Box<dyn std::error::Error>> {
    let x = get_x()?;
    let y = get_y()?;
    Ok(x + y)
}

fn main() {
    println!("{:?}", foo());
}</pre>
<p>Това рядко ще е проблем откъм performance (освен ако не пишете eclipse, I guess: <a href="https://twitter.com/pcwalton/status/1169004435856592901" target="_blank">https://twitter.com/pcwalton/status/1169004435856592901</a>)</p>
</div><div class="slide">
<h1 id="box">Box</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="6c6545471513af2313d231aab4fffb0257536d45">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">curry_static</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">a</span>: <span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-keyword">impl</span> <span class="tshl-type">Fn</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type_builtin">u32</span> {
    <span class="tshl-keyword">move</span> |b| a + b
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">curry_dynamic</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">a</span>: <span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-keyword">dyn</span> <span class="tshl-type">Fn</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-keyword">move</span> |b| a + b<span class="tshl-punctuation_bracket">)</span>
}

<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, curry_static<span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, curry_dynamic<span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">3
3</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="6c6545471513af2313d231aab4fffb0257536d45">fn curry_static(a: u32) -> impl Fn(u32) -> u32 {
    move |b| a + b
}

fn curry_dynamic(a: u32) -> Box<dyn Fn(u32) -> u32> {
    Box::new(move |b| a + b)
}

fn main() {
println!("{}", curry_static(1)(2));
println!("{}", curry_dynamic(1)(2));
}</pre>
<p>В този конкретен случай, и двете са валидни начини да постигнем решението. Но <code>impl</code> се свежда до <em>един конкретен</em> тип at compile-time.</p>
</div><div class="slide">
<h1 id="box">Box</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="f43c6a22a17902a81b9793a8e87db8b3f51578c9">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">struct</span> <span class="tshl-type">UiElement</span> {
    <span class="tshl-property">title</span>: <span class="tshl-type">String</span>,
    <span class="tshl-property">on_click</span>: <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-keyword">dyn</span> <span class="tshl-type">Fn</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">&gt;</span>,
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> clicker = <span class="tshl-type">UiElement</span> {
        <span class="tshl-property">title</span>: <span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;Yoda Clicker&quot;</span><span class="tshl-punctuation_bracket">)</span>,
        <span class="tshl-property">on_click</span>: <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span>|| <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;Clicked, I have been!&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>,
    }<span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-punctuation_bracket">(</span>clicker<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">on_click</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    clicker<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">on_click</span> = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span>|| <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;Click, or click not -- there is no hover&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-punctuation_bracket">(</span>clicker<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">on_click</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">Clicked, I have been!
Click, or click not -- there is no hover</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="f43c6a22a17902a81b9793a8e87db8b3f51578c9">struct UiElement {
    title: String,
    on_click: Box<dyn Fn()>,
}

fn main() {
    let mut clicker = UiElement {
        title: String::from("Yoda Clicker"),
        on_click: Box::new(|| println!("Clicked, I have been!")),
    };

    (clicker.on_click)();
    clicker.on_click = Box::new(|| println!("Click, or click not -- there is no hover"));
    (clicker.on_click)();
}</pre>
</div><div class="slide">
<h1 id="nightly-rust">Nightly Rust</h1>
<ul>
<li>В nightly rust има експериментален синтаксис</li>
</ul>
</div><div class="slide subslide">
<h1 id="nightly-rust">Nightly Rust</h1>
<ul>
<li>В nightly rust има експериментален синтаксис</li>
<li>Можете да си инсталирате nightly rust с <code>rustup install nightly</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="nightly-rust">Nightly Rust</h1>
<ul>
<li>В nightly rust има експериментален синтаксис</li>
<li>Можете да си инсталирате nightly rust с <code>rustup install nightly</code></li>
<li>Можете да си тествате код с <code>cargo +nightly run</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="nightly-rust">Nightly Rust</h1>
<ul>
<li>В nightly rust има експериментален синтаксис</li>
<li>Можете да си инсталирате nightly rust с <code>rustup install nightly</code></li>
<li>Можете да си тествате код с <code>cargo +nightly run</code></li>
<li>Можете и да го направите default-ен</li>
</ul>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="nightly-features">Nightly features</h3>
<p>Има специален keyword : <code>box</code> за създаване на Box smart pointer-и</p>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> x = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> list = <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-comment">// Може да се напише така:</span>
<span class="tshl-keyword">let</span> x = box <span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> list = <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, box <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span>, box <span class="tshl-constructor">Cons</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span>, box <span class="tshl-constructor">Nil</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="nightly-features">Nightly features</h3>
<p>За да може да използвате този 'feature', трябва да го оповестите така в началото на програмата си:</p>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#!<span class="tshl-punctuation_bracket">[</span>feature<span class="tshl-punctuation_bracket">(</span>box_syntax<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>

<span class="tshl-keyword">struct</span> <span class="tshl-type">Heart</span> {
    <span class="tshl-property">owner</span>: <span class="tshl-operator">&amp;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">static</span> <span class="tshl-type_builtin">str</span>,
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
  <span class="tshl-keyword">let</span> heart_shaped_box = box <span class="tshl-type">Heart</span> { <span class="tshl-property">owner</span>: <span class="tshl-string">&quot;Kurt&quot;</span> }<span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="nightly-features">Nightly features</h3>
<p>Ключовата дума <code>box</code> е мнооого полезна при pattern matching! Пример:</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="f2ac0b3f262ed0eb527cb746d235e3ce0fe4306f">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>derive<span class="tshl-punctuation_bracket">(</span><span class="tshl-constructor">Clone</span>, <span class="tshl-constructor">Debug</span>, <span class="tshl-constructor">PartialEq</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-keyword">pub</span> <span class="tshl-keyword">enum</span> <span class="tshl-type">Term</span> {
    <span class="tshl-constructor">True</span>,
    <span class="tshl-constructor">False</span>,
    <span class="tshl-constructor">If</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Term</span><span class="tshl-punctuation_bracket">&gt;</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Term</span><span class="tshl-punctuation_bracket">&gt;</span>, <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Term</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span>,
    <span class="tshl-constructor">Value</span>
}</code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="f2ac0b3f262ed0eb527cb746d235e3ce0fe4306f">#[derive(Clone, Debug, PartialEq)]
pub enum Term {
    True,
    False,
    If(Box<Term>, Box<Term>, Box<Term>),
    Value
}
fn main() {}</pre>
<p>Типа <code>Box&lt;Term&gt;</code> не може да се pattern-match-не по компоненти -- вътрешността му е private.</p>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="nightly-features">Nightly features</h3>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="fc419a54629d4e4e76c3f7b8dd1df10383149b2e">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">one_step_eval</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">t</span>: <span class="tshl-type">Term</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Result</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Term</span>, <span class="tshl-type">String</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-keyword">match</span> t {
        <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">If</span><span class="tshl-punctuation_bracket">(</span>t1, t2, t3<span class="tshl-punctuation_bracket">)</span> =&gt; {
            <span class="tshl-keyword">match</span> <span class="tshl-operator">*</span>t1 { <span class="tshl-comment">// След малко ще си говорим за Deref, спокойно!</span>
                <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">True</span> =&gt; <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">*</span>t2<span class="tshl-punctuation_bracket">)</span>,
                <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">False</span> =&gt; <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">*</span>t3<span class="tshl-punctuation_bracket">)</span>,
                _ =&gt; <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">If</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-function">one_step_eval</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">*</span>t1<span class="tshl-punctuation_bracket">)</span>?<span class="tshl-punctuation_bracket">)</span>, t2, t3<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>,
            }
        },
        any =&gt; <span class="tshl-constructor">Err</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-function_macro">format</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;Term can&#39;t be evaluated : {:?}&quot;</span>, any<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>
    }
}</code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="fc419a54629d4e4e76c3f7b8dd1df10383149b2e">#![allow(dead_code)]
#[derive(Clone, Debug, PartialEq)]
pub enum Term {
True,
False,
If(Box<Term>, Box<Term>, Box<Term>),
Value
}
fn one_step_eval(t: Term) -> Result<Term, String> {
    match t {
        Term::If(t1, t2, t3) => {
            match *t1 { // След малко ще си говорим за Deref, спокойно!
                Term::True => Ok(*t2),
                Term::False => Ok(*t3),
                _ => Ok(Term::If(Box::new(one_step_eval(*t1)?), t2, t3)),
            }
        },
        any => Err(format!("Term can't be evaluated : {:?}", any))
    }
}
fn main() {}</pre>
</div><div class="slide">
<h1 id="box">Box</h1>
<h3 id="nightly-features">Nightly features</h3>
<p>Използвайки <code>feature(box_patterns)</code>, можем да pattern-match-ваме <code>Box&lt;Term&gt;</code>:</p>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-attribute">#!<span class="tshl-punctuation_bracket">[</span>feature<span class="tshl-punctuation_bracket">(</span>box_syntax<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>
<span class="tshl-attribute">#!<span class="tshl-punctuation_bracket">[</span>feature<span class="tshl-punctuation_bracket">(</span>box_patterns<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">]</span></span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">one_step_eval</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">t</span>: <span class="tshl-type">Term</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Result</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Term</span>, <span class="tshl-type">String</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-keyword">match</span> t {
        <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">If</span><span class="tshl-punctuation_bracket">(</span>box <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">True</span>, t2, _<span class="tshl-punctuation_bracket">)</span> =&gt; <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">*</span>t2<span class="tshl-punctuation_bracket">)</span>,
        <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">If</span><span class="tshl-punctuation_bracket">(</span>box <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">False</span>, _, t3<span class="tshl-punctuation_bracket">)</span> =&gt; <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">*</span>t3<span class="tshl-punctuation_bracket">)</span>,
        <span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">If</span><span class="tshl-punctuation_bracket">(</span>t1, t2, t3<span class="tshl-punctuation_bracket">)</span> =&gt; <span class="tshl-constructor">Ok</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">Term</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">If</span><span class="tshl-punctuation_bracket">(</span>box <span class="tshl-function">one_step_eval</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">*</span>t1<span class="tshl-punctuation_bracket">)</span>?, t2, t3<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>,
        any =&gt; <span class="tshl-constructor">Err</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-function_macro">format</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;Term can&#39;t be evaluated : {:?}&quot;</span>, any<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>
    }
}</code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="deref">Deref</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="37453807388787c610bf70fa3e4eb3ce734a1eec">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> x = <span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>
{
    <span class="tshl-keyword">let</span> y = <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> x<span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-operator">*</span>y += <span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span>
}
<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, x<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">6</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="37453807388787c610bf70fa3e4eb3ce734a1eec">fn main() {
let mut x = 5;
{
    let y = &mut x;

    *y += 1;
}
println!("{}", x);
}</pre>
<p>Може да достъпим стойността зад reference-а чрез <code>*</code> и да извършим някаква операция върху нея.</p>
</div><div class="slide">
<h1 id="deref">Deref</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="33da966dbb1755ea752a600e84ed2df0c67d6f88">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> x = <span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>
{
    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> y = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span>x<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-operator">*</span>y += <span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, y<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}
<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, x<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">6
5</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="33da966dbb1755ea752a600e84ed2df0c67d6f88">fn main() {
let x = 5;
{
    let mut y = Box::new(x);

    *y += 1;
    println!("{}", y);
}
println!("{}", x);
}</pre>
<p>Това работи и за <code>Box</code>-нати стойности, защото за типа <code>Box</code> е имплементиран trait-а <code>Deref</code>.</p>
</div><div class="slide">
<h1 id="deref">Deref</h1>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">pub</span> <span class="tshl-keyword">trait</span> <span class="tshl-type">Deref</span> {
    <span class="tshl-keyword">type</span> <span class="tshl-type">Target</span>: ?<span class="tshl-type">Sized</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">fn</span> <span class="tshl-function">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-constructor">Self</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-type">Target</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    
                </div>
                
<p>Нужно е <code>?Sized</code>, понеже така може да имплементираме <code>Deref</code> за не-Sized тип. От стандартната библиотека:</p>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">pub</span> <span class="tshl-keyword">trait</span> <span class="tshl-type">Deref</span> {
    <span class="tshl-keyword">type</span> <span class="tshl-type">Target</span>: ?<span class="tshl-type">Sized</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">fn</span> <span class="tshl-function">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-constructor">Self</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-type">Target</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    
                </div>
                
<p>Нужно е <code>?Sized</code>, понеже така може да имплементираме <code>Deref</code> за не-Sized тип. От стандартната библиотека:</p>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">impl</span> ops<span class="tshl-punctuation_delimiter">::</span><span class="tshl-type">Deref</span> <span class="tshl-keyword">for</span> <span class="tshl-type">String</span> {
    <span class="tshl-keyword">type</span> <span class="tshl-type">Target</span> = <span class="tshl-type_builtin">str</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-attribute">#<span class="tshl-punctuation_bracket">[</span>inline<span class="tshl-punctuation_bracket">]</span></span>
    <span class="tshl-keyword">fn</span> <span class="tshl-function">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-type_builtin">str</span> {
        <span class="tshl-keyword">unsafe</span> { str<span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from_utf8_unchecked</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">vec</span><span class="tshl-punctuation_bracket">)</span> }
    }
}</code></pre>
                    </div>
                    
                </div>
                
<p>Тук типа <code>Target</code> е <code>str</code>, който не е <code>Sized</code>. Но <code>&amp;str</code> тотално е <code>Sized</code> и можем да върнем <code>&amp;Target</code> като резултат.</p>
<p>Метода <code>deref</code> не връща директно <code>Target</code>, защото това би ни дало ownership над стойността и в случая на <code>Box&lt;T&gt;</code>, това би преместило стойността и би направило инстанцията неизползваема.</p>
</div><div class="slide">
<h1 id="derefmut">DerefMut</h1>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">pub</span> <span class="tshl-keyword">trait</span> <span class="tshl-type">DerefMut</span>: <span class="tshl-type">Deref</span> {
    <span class="tshl-keyword">fn</span> <span class="tshl-function">deref_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-constructor">Self</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-type">Target</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    
                </div>
                
<p>Забележете липсата на декларация на <code>Target</code> -- на практика се случва <code>&lt;Self as Deref&gt;::Target</code>.</p>
</div><div class="slide">
<h1 id="deref">Deref</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="d37126242359fc1145bddc9c5dc87dc6f06223c9">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>ops<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">Deref</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">struct</span> <span class="tshl-type">Mp3</span> {
    <span class="tshl-property">audio</span>: <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">&gt;</span>,
    <span class="tshl-property">artist</span>: <span class="tshl-type">Option</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">String</span><span class="tshl-punctuation_bracket">&gt;</span>,
    <span class="tshl-property">title</span>: <span class="tshl-type">Option</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">String</span><span class="tshl-punctuation_bracket">&gt;</span>,
}

<span class="tshl-keyword">impl</span> <span class="tshl-type">Deref</span> <span class="tshl-keyword">for</span> <span class="tshl-type">Mp3</span> {
    <span class="tshl-keyword">type</span> <span class="tshl-type">Target</span> = <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-keyword">fn</span> <span class="tshl-function">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">&gt;</span> {
        <span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">audio</span>
    }
}</code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="d37126242359fc1145bddc9c5dc87dc6f06223c9">#![allow(dead_code)]
use std::ops::Deref;

struct Mp3 {
    audio: Vec<u8>,
    artist: Option<String>,
    title: Option<String>,
}

impl Deref for Mp3 {
    type Target = Vec<u8>;

    fn deref(&self) -> &Vec<u8> {
        &self.audio
    }
}
fn main() {}</pre>
</div><div class="slide">
<h1 id="deref">Deref</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="534aea586a400c8e5f30c0a550b715b521a3b412">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> appropriately_named_song = <span class="tshl-type">Mp3</span> {
        <span class="tshl-property">audio</span>: <span class="tshl-function_macro">vec</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-constant_builtin">2</span>, <span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">]</span>,
        <span class="tshl-property">artist</span>: <span class="tshl-constructor">Some</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;Poets of the Fall&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>,
        <span class="tshl-property">title</span>: <span class="tshl-constructor">Some</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;Carnival of Rust&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>,
    }<span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">assert_eq</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span>vec!<span class="tshl-punctuation_bracket">[</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-constant_builtin">2</span>, <span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">]</span>, *appropriately_named_song<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="534aea586a400c8e5f30c0a550b715b521a3b412">#![allow(dead_code)]
use std::ops::Deref;
struct Mp3 {
audio: Vec<u8>,
artist: Option<String>,
title: Option<String>,
}
impl Deref for Mp3 {
type Target = Vec<u8>;
fn deref(&self) -> &Vec<u8> {
&self.audio
}
}
fn main() {
    let appropriately_named_song = Mp3 {
        audio: vec![1, 2, 3],
        artist: Some(String::from("Poets of the Fall")),
        title: Some(String::from("Carnival of Rust")),
    };

    assert_eq!(vec![1, 2, 3], *appropriately_named_song);
}</pre>
</div><div class="slide">
<h1 id="deref">Deref</h1>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-operator">*</span>appropriately_named_song

<span class="tshl-operator">*</span><span class="tshl-punctuation_bracket">(</span>appropriately_named_song<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter"></span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">audio</span>
}

<span class="tshl-operator">*</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>appropriately_named_song<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">audio</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter"></span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="deref">Deref</h1>
<ul>
<li>Позволява свеждане на нещо-което-работи-като-указател до истински указател</li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<ul>
<li>Позволява свеждане на нещо-което-работи-като-указател до истински указател</li>
<li>Извиква се автоматично от <code>*</code>: Когато напишем <code>*foo</code>, компилатора го свежда до <code>*Deref::deref(&amp;foo)</code>.</li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<ul>
<li>Позволява свеждане на нещо-което-работи-като-указател до истински указател</li>
<li>Извиква се автоматично от <code>*</code>: Когато напишем <code>*foo</code>, компилатора го свежда до <code>*Deref::deref(&amp;foo)</code>.</li>
<li>Извиква се автоматично от <code>*=</code>: Когато напишем <code>*foo = ...</code>, компилатора го свежда до <code>*(DerefMut::deref_mut(&amp;mut foo)) = ...</code>.</li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<ul>
<li>Позволява свеждане на нещо-което-работи-като-указател до истински указател</li>
<li>Извиква се автоматично от <code>*</code>: Когато напишем <code>*foo</code>, компилатора го свежда до <code>*Deref::deref(&amp;foo)</code>.</li>
<li>Извиква се автоматично от <code>*=</code>: Когато напишем <code>*foo = ...</code>, компилатора го свежда до <code>*(DerefMut::deref_mut(&amp;mut foo)) = ...</code>.</li>
<li>Извиква се автоматично и в няколко други ситуации, които ще видим след няколко слайда</li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<ul>
<li>Позволява свеждане на нещо-което-работи-като-указател до истински указател</li>
<li>Извиква се автоматично от <code>*</code>: Когато напишем <code>*foo</code>, компилатора го свежда до <code>*Deref::deref(&amp;foo)</code>.</li>
<li>Извиква се автоматично от <code>*=</code>: Когато напишем <code>*foo = ...</code>, компилатора го свежда до <code>*(DerefMut::deref_mut(&amp;mut foo)) = ...</code>.</li>
<li>Извиква се автоматично и в няколко други ситуации, които ще видим след няколко слайда</li>
<li>Дефиниран е автоматично за references.</li>
</ul>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">impl</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span>, <span class="tshl-type">T</span>: ?<span class="tshl-type">Sized</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-type">Deref</span> <span class="tshl-keyword">for</span> <span class="tshl-operator">&amp;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span> <span class="tshl-type">T</span> {
    <span class="tshl-keyword">type</span> <span class="tshl-type">Target</span> = <span class="tshl-type">T</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-keyword">fn</span> <span class="tshl-function">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-type">T</span> { <span class="tshl-operator">*</span><span class="tshl-variable_builtin">self</span> }
}</code></pre>
                    </div>
                    
                </div>
                
<p>Въпрос: защо <code>*self</code>?</p>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<ul>
<li>Позволява свеждане на нещо-което-работи-като-указател до истински указател</li>
<li>Извиква се автоматично от <code>*</code>: Когато напишем <code>*foo</code>, компилатора го свежда до <code>*Deref::deref(&amp;foo)</code>.</li>
<li>Извиква се автоматично от <code>*=</code>: Когато напишем <code>*foo = ...</code>, компилатора го свежда до <code>*(DerefMut::deref_mut(&amp;mut foo)) = ...</code>.</li>
<li>Извиква се автоматично и в няколко други ситуации, които ще видим след няколко слайда</li>
<li>Дефиниран е автоматично за references.</li>
</ul>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">impl</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span>, <span class="tshl-type">T</span>: ?<span class="tshl-type">Sized</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-type">Deref</span> <span class="tshl-keyword">for</span> <span class="tshl-operator">&amp;</span><span class="tshl-operator">&#39;</span><span class="tshl-label">a</span> <span class="tshl-type">T</span> {
    <span class="tshl-keyword">type</span> <span class="tshl-type">Target</span> = <span class="tshl-type">T</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-keyword">fn</span> <span class="tshl-function">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-variable_builtin">self</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-type">T</span> { <span class="tshl-operator">*</span><span class="tshl-variable_builtin">self</span> }
}</code></pre>
                    </div>
                    
                </div>
                
<p>Въпрос: защо <code>*self</code>?</p>
<p>Защото <code>&amp;self</code> е от тип <code>&amp;Self</code>, което в случая е <code>&amp;&amp;T</code>. Така че <code>*self</code> е от тип <code>&amp;T</code>!</p>
</div><div class="slide">
<h1 id="derefmut">DerefMut</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="fc9809eda8c2d45e602e19f6cf41465299d2f5f9">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-comment">//</span>
<span class="tshl-comment">//</span>
<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> y: <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">&gt;</span> = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Note: mutable</span>

    <span class="tshl-operator">*</span>y += <span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, y<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">6</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="fc9809eda8c2d45e602e19f6cf41465299d2f5f9">//
fn main() {
    let mut y: Box<u32> = Box::new(5); // Note: mutable

    *y += 1;
    println!("{}", y);
}</pre>
</div><div class="slide">
<h1 id="derefmut">DerefMut</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="d80a73e29ffffa8bf858e35162f67ffd980819fb">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>ops<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">DerefMut</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> y: <span class="tshl-type">Box</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">&gt;</span> = <span class="tshl-type">Box</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Note: mutable</span>

    <span class="tshl-operator">*</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">DerefMut</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">deref_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> y<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span> += <span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">//*(&amp;mut u32)</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, y<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">6</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="d80a73e29ffffa8bf858e35162f67ffd980819fb">use std::ops::DerefMut;

fn main() {
    let mut y: Box<u32> = Box::new(5); // Note: mutable

    *(DerefMut::deref_mut(&mut y)) += 1; //*(&mut u32)
    println!("{}", y);
}</pre>
</div><div class="slide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">audio</span>: <span class="tshl-operator">&amp;</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">]</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-comment">// ...</span>
}

<span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span>appropriately_named_song<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">audio</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">as_slice</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter"></span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>
<ul>
<li><code>&amp;[u32; 5]</code> &rarr; <code>&amp;[u32]</code></li>
<li><code>&amp;Vec&lt;u32&gt;</code> &rarr; <code>&amp;[u32]</code></li>
<li><code>&amp;String</code> &rarr; <code>&amp;str</code></li>
</ul>
</div><div class="slide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">audio</span>: <span class="tshl-operator">&amp;</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">]</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-comment">// ...</span>
}

<span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span>appropriately_named_song<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">audio</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">as_slice</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>
<span class="tshl-comment">// &amp;Vec&lt;u8&gt; -&gt; &amp;[u8]</span><span class="tshl-punctuation_delimiter"></span>
<span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>appropriately_named_song<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">audio</span><span class="tshl-punctuation_bracket">)</span>
<span class="tshl-comment">// &amp;Mp3 -&gt; &amp;Vec&lt;u8&gt;</span><span class="tshl-punctuation_delimiter"></span>
<span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>appropriately_named_song<span class="tshl-punctuation_bracket">)</span>

<span class="tshl-comment">// Става и без викане на функция:</span><span class="tshl-punctuation_delimiter"></span>
<span class="tshl-keyword">let</span> song_bytes: <span class="tshl-operator">&amp;</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">]</span> = <span class="tshl-operator">&amp;</span>appropriately_named_song<span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">audio</span>: <span class="tshl-operator">&amp;</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">]</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-comment">// ...</span>
}

<span class="tshl-comment">//</span>
<span class="tshl-comment">//</span>
<span class="tshl-comment">//</span>
<span class="tshl-comment">//</span>
<span class="tshl-function">compress_mp3</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>appropriately_named_song<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>

<span class="tshl-comment">// Става и без викане на функция:</span><span class="tshl-punctuation_delimiter"></span>
<span class="tshl-keyword">let</span> song_bytes: <span class="tshl-operator">&amp;</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-type_builtin">u8</span><span class="tshl-punctuation_bracket">]</span> = <span class="tshl-operator">&amp;</span>appropriately_named_song<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>
<ul>
<li>От <code>&amp;T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>
<ul>
<li>От <code>&amp;T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
<li>От <code>&amp;mut T</code> до <code>&amp;mut U</code> когато <code>T: DerefMut&lt;Target=U&gt;</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>
<ul>
<li>От <code>&amp;T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
<li>От <code>&amp;mut T</code> до <code>&amp;mut U</code> когато <code>T: DerefMut&lt;Target=U&gt;</code></li>
<li>От <code>&amp;mut T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>
<ul>
<li>От <code>&amp;T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
<li>От <code>&amp;mut T</code> до <code>&amp;mut U</code> когато <code>T: DerefMut&lt;Target=U&gt;</code></li>
<li>От <code>&amp;mut T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
<li>(Вижте документацията на String, където ще намерите "Methods from <code>Deref&lt;Target = str&gt;</code>")</li>
<li>(<a href="https://doc.rust-lang.org/std/string/struct.String.html#deref-methods" target="_blank">https://doc.rust-lang.org/std/string/struct.String.html#deref-methods</a>)</li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<h3 id="deref-coercion">deref coercion</h3>
<ul>
<li>От <code>&amp;T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
<li>От <code>&amp;mut T</code> до <code>&amp;mut U</code> когато <code>T: DerefMut&lt;Target=U&gt;</code></li>
<li>От <code>&amp;mut T</code> до <code>&amp;U</code> когато <code>T: Deref&lt;Target=U&gt;</code></li>
<li>(Вижте документацията на String, където ще намерите "Methods from <code>Deref&lt;Target = str&gt;</code>")</li>
<li>(<a href="https://doc.rust-lang.org/std/string/struct.String.html#deref-methods" target="_blank">https://doc.rust-lang.org/std/string/struct.String.html#deref-methods</a>)</li>
<li>От <code>&amp;mut T</code> до <code>&amp;T</code> (просто "coercion", не "deref coercion")</li>
</ul>
</div><div class="slide">
<h1 id="deref">Deref</h1>
<ul>
<li>Цялата тая имплицитност е много удобна, но… Не прекалявайте. <code>Deref</code> се ползва <em>специфично</em> за smart pointer-и.</li>
</ul>
</div><div class="slide subslide">
<h1 id="deref">Deref</h1>
<ul>
<li>Цялата тая имплицитност е много удобна, но… Не прекалявайте. <code>Deref</code> се ползва <em>специфично</em> за smart pointer-и.</li>
<li><code>Mp3</code> е симпатичен пример, но автоматичен дереф може да е доста объркващ в случай на грешка.</li>
</ul>
</div><div class="slide">
<h1 id="rc">Rc</h1>
<p>Reference counter</p>
<p><img src="resources/rc.png" /></p>
</div><div class="slide">
<h1 id="reference-counting">Reference counting</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="94f80f3c20ff909712caba30a7ff408e3bc6d3a9">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>rc<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">Rc</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> first = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;foobar&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> second = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">clone</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>first<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, first<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, second<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">foobar
foobar</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="94f80f3c20ff909712caba30a7ff408e3bc6d3a9">use std::rc::Rc;

fn main() {
    let first = Rc::new(String::from("foobar"));
    let second = Rc::clone(&first);

    println!("{}", first);
    println!("{}", second);
}</pre>
</div><div class="slide">
<h1 id="reference-counting">Reference counting</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="c8adf5fd8c3b9767da803ed009fa88d268c1462e">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> a = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> b = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, *a + *b<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">8</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="c8adf5fd8c3b9767da803ed009fa88d268c1462e">use std::rc::Rc;
fn main() {
let a = Rc::new(3);
let b = Rc::new(5);

println!("{}", *a + *b);
}</pre>
</div><div class="slide">
<h1 id="reference-counting">Reference counting</h1>
<ul>
<li><code>Rc::new</code> алокира подадената си стойност на heap-а, както Box</li>
</ul>
</div><div class="slide subslide">
<h1 id="reference-counting">Reference counting</h1>
<ul>
<li><code>Rc::new</code> алокира подадената си стойност на heap-а, както Box</li>
<li><code>Rc::clone</code> дава ново <code>Rc</code>, което вътрешно сочи до същата стойност, но има ownership, също както Box!</li>
</ul>
</div><div class="slide subslide">
<h1 id="reference-counting">Reference counting</h1>
<ul>
<li><code>Rc::new</code> алокира подадената си стойност на heap-а, както Box</li>
<li><code>Rc::clone</code> дава ново <code>Rc</code>, което вътрешно сочи до същата стойност, но има ownership, също както Box!</li>
<li>Всяко викане на <code>clone</code>, вместо да клонира потенциално голямата стойност, просто връща фасада към тази стойност и увеличава един counter.</li>
</ul>
</div><div class="slide subslide">
<h1 id="reference-counting">Reference counting</h1>
<ul>
<li><code>Rc::new</code> алокира подадената си стойност на heap-а, както Box</li>
<li><code>Rc::clone</code> дава ново <code>Rc</code>, което вътрешно сочи до същата стойност, но има ownership, също както Box!</li>
<li>Всяко викане на <code>clone</code>, вместо да клонира потенциално голямата стойност, просто връща фасада към тази стойност и увеличава един counter.</li>
<li>Когато <code>Rc</code>-то се drop-не, counter-а пада с 1. Като падне до 0, стойността се деалокира.</li>
</ul>
</div><div class="slide">
<h1 id="reference-counting">Reference counting</h1>
<p>Проблем: стойността е read-only:</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="daef8d7d55ceabff0dc2ebe0ac97186bb40b3b39">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> a = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-operator">*</span>a = <span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, a<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs"><span style="font-weight:bold;color:rgb(255,85,85)">error[E0594]</span><span style="font-weight:bold">: cannot assign to data in an `Rc`</span>
 <span style="font-weight:bold;color:rgb(85,85,255)">--&gt; </span>src/bin/main_daef8d7d55ceabff0dc2ebe0ac97186bb40b3b39.rs:5:1
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">5</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>*a = 5;
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span><span style="font-weight:bold;color:rgb(255,85,85)">^^^^^^</span> <span style="font-weight:bold;color:rgb(255,85,85)">cannot assign</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">= </span><span style="font-weight:bold">help</span>: trait `DerefMut` is required to modify through a dereference, but it is not implemented for `Rc&lt;i32&gt;`

<span style="font-weight:bold">For more information about this error, try `rustc --explain E0594`.</span>
<span style="font-weight:bold;color:rgb(255,85,85)">error</span><span style="font-weight:bold">:</span> could not compile `rust` due to previous error</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="daef8d7d55ceabff0dc2ebe0ac97186bb40b3b39">use std::rc::Rc;
fn main() {
let mut a = Rc::new(3);

*a = 5;

println!("{:?}", a);
}</pre>
</div><div class="slide">
<h1 id="reference-counting">Reference counting</h1>
<ul>
<li><code>Rc</code> не ни позволява да взимаме mutable reference към пазената стойност</li>
</ul>
</div><div class="slide subslide">
<h1 id="reference-counting">Reference counting</h1>
<ul>
<li><code>Rc</code> не ни позволява да взимаме mutable reference към пазената стойност</li>
<li>това би нарушило ограничението за един <code>&amp;mut T</code> / много <code>&amp;T</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="reference-counting">Reference counting</h1>
<ul>
<li><code>Rc</code> не ни позволява да взимаме mutable reference към пазената стойност</li>
<li>това би нарушило ограничението за един <code>&amp;mut T</code> / много <code>&amp;T</code></li>
<li>но въпреки това има начини да модифицираме пазената стойност</li>
</ul>
</div><div class="slide">
<h1 id="cow">Cow</h1>
<p><img src="resources/cow.jpg" /></p>
</div><div class="slide">
<h1 id="cow">Cow</h1>
<h3 id="copy-on-write">Copy on Write</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">impl</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-keyword">where</span> <span class="tshl-type">T</span>: <span class="tshl-type">Clone</span> {
    <span class="tshl-keyword">fn</span> <span class="tshl-function">make_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">this</span>: <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-type">T</span><span class="tshl-punctuation_delimiter"></span>
}</code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide subslide">
<h1 id="cow">Cow</h1>
<h3 id="copy-on-write">Copy on Write</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">impl</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-keyword">where</span> <span class="tshl-type">T</span>: <span class="tshl-type">Clone</span> {
    <span class="tshl-keyword">fn</span> <span class="tshl-function">make_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">this</span>: <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-type">T</span><span class="tshl-punctuation_delimiter"></span>
}</code></pre>
                    </div>
                    
                </div>
                
<ul>
<li>ако сме единствения собственик модифицираме директно пазената стойност</li>
</ul>
</div><div class="slide subslide">
<h1 id="cow">Cow</h1>
<h3 id="copy-on-write">Copy on Write</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">impl</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span> <span class="tshl-keyword">where</span> <span class="tshl-type">T</span>: <span class="tshl-type">Clone</span> {
    <span class="tshl-keyword">fn</span> <span class="tshl-function">make_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">this</span>: <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">T</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-type">T</span><span class="tshl-punctuation_delimiter"></span>
}</code></pre>
                    </div>
                    
                </div>
                
<ul>
<li>ако сме единствения собственик модифицираме директно пазената стойност</li>
<li>ако не първо си правим копие на стойността и модифицираме копието</li>
</ul>
</div><div class="slide">
<h1 id="cow">Cow</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="e8fc9dcab4cb634ba3e2edbf3ce3301ba945ce3a">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>rc<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">Rc</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> a = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-operator">*</span><span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">make_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> a<span class="tshl-punctuation_bracket">)</span> = <span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;a: {}&quot;</span>, a<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">a: 5</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="e8fc9dcab4cb634ba3e2edbf3ce3301ba945ce3a">use std::rc::Rc;

fn main() {
    let mut a = Rc::new(3);

    *Rc::make_mut(&mut a) = 5;

    println!("a: {}", a);
}</pre>
</div><div class="slide">
<h1 id="cow">Cow</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="dc4b6804e69f8294e2213a5f42e1edab41581658">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>rc<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">Rc</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> a = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">3</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> b = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">clone</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>a<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-comment">// Дотук a и b сочат към една и съща стойност в паметта</span>

    {
        <span class="tshl-keyword">let</span> temp_ref = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">make_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> a<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
        <span class="tshl-comment">// Връщаме &amp;mut към copy-on-write стойност</span>
        <span class="tshl-operator">*</span>temp_ref = <span class="tshl-constant_builtin">5</span><span class="tshl-punctuation_delimiter">;</span>
    }
    <span class="tshl-comment">// Вече a и b сочат към различни стойности</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;a: {}&quot;</span>, a<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;b: {}&quot;</span>, b<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">a: 5
b: 3</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="dc4b6804e69f8294e2213a5f42e1edab41581658">use std::rc::Rc;

fn main() {
    let mut a = Rc::new(3);
    let b = Rc::clone(&a);
    // Дотук a и b сочат към една и съща стойност в паметта

    {
        let temp_ref = Rc::make_mut(&mut a);
        // Връщаме &mut към copy-on-write стойност
        *temp_ref = 5;
    }
    // Вече a и b сочат към различни стойности

    println!("a: {}", a);
    println!("b: {}", b);
}</pre>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>
<ul>
<li>пазим състояние (internal state), невидимо за външния свят</li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<ul>
<li>пазим състояние (internal state), невидимо за външния свят</li>
<li>искаме да модифицираме това състояние в методи, които са логически immutable</li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<ul>
<li>пазим състояние (internal state), невидимо за външния свят</li>
<li>искаме да модифицираме това състояние в методи, които са логически immutable</li>
<li>това се нарича internal mutability</li>
</ul>
</div><div class="slide">
<h1 id="cell-refcell">Cell, RefCell</h1>
<p><img src="resources/cell.png" /></p>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="c1ad0b1ad2f8dd05fd4ab3a68f73c6c10267adbd">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>cell<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">Cell</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-comment">// забележете, че няма `mut`</span>
    <span class="tshl-keyword">let</span> cell = <span class="tshl-type">Cell</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">10</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, cell.get<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    cell<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">set</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">42</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, cell.get<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">10
42</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="c1ad0b1ad2f8dd05fd4ab3a68f73c6c10267adbd">use std::cell::Cell;

fn main() {
    // забележете, че няма `mut`
    let cell = Cell::new(10);

    println!("{}", cell.get());

    cell.set(42);
    println!("{}", cell.get());
}</pre>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="cell">Cell</h3>
<ul>
<li>използва се основно за <code>Copy</code> типове</li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="cell">Cell</h3>
<ul>
<li>използва се основно за <code>Copy</code> типове</li>
<li><code>get</code> прави копие на пазената стойност</li>
<li><code>set</code> презаписва пазената стойност с новата</li>
<li><code>replace</code> записва нова стойност и връща старата</li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="cell">Cell</h3>
<ul>
<li>използва се основно за <code>Copy</code> типове</li>
<li><code>get</code> прави копие на пазената стойност</li>
<li><code>set</code> презаписва пазената стойност с новата</li>
<li><code>replace</code> записва нова стойност и връща старата</li>
<li><code>into_inner</code> ще консумира <code>Cell</code>-а и директно ще върне вътрешната стойност</li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="cell">Cell</h3>
<ul>
<li>използва се основно за <code>Copy</code> типове</li>
<li><code>get</code> прави копие на пазената стойност</li>
<li><code>set</code> презаписва пазената стойност с новата</li>
<li><code>replace</code> записва нова стойност и връща старата</li>
<li><code>into_inner</code> ще консумира <code>Cell</code>-а и директно ще върне вътрешната стойност</li>
<li>не можем да вземем референция (<code>&amp;</code>/<code>&amp;mut</code>) към вътрешната стойност, само към обвиващия <code>Cell</code></li>
</ul>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="be643871560c769b4efb72de5b24d13234db4dd7">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>cell<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">RefCell</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> cell = <span class="tshl-type">RefCell</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;foo&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>   <span class="tshl-comment">// отново няма `mut`</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, cell.borrow<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// -&gt; Ref&lt;String&gt;</span>

    {
        <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> r = cell<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">borrow_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// -&gt; RefMut&lt;String&gt;</span>
        r<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">push_str</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;bar&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    }

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, cell.borrow<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// -&gt; Ref&lt;String&gt;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">foo
foobar</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="be643871560c769b4efb72de5b24d13234db4dd7">use std::cell::RefCell;

fn main() {
    let cell = RefCell::new(String::from("foo"));   // отново няма `mut`
    println!("{}", cell.borrow()); // -> Ref<String>

    {
        let mut r = cell.borrow_mut(); // -> RefMut<String>
        r.push_str("bar");
    }

    println!("{}", cell.borrow()); // -> Ref<String>
}</pre>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="61b209e6118b5106ba896100a88e29ac1606650c">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>cell<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">RefCell</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> cell = <span class="tshl-type">RefCell</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;foo&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>   <span class="tshl-comment">// отново няма `mut`</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, cell.borrow<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    cell<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">borrow_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">push_str</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;bar&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, cell.borrow<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">foo
foobar</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="61b209e6118b5106ba896100a88e29ac1606650c">use std::cell::RefCell;

fn main() {
    let cell = RefCell::new(String::from("foo"));   // отново няма `mut`
    println!("{}", cell.borrow());

    cell.borrow_mut().push_str("bar");

    println!("{}", cell.borrow());
}</pre>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="45bb39151537827e2a223fcdd3995ba26df346ef">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>cell<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">RefCell</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> cell = <span class="tshl-type">RefCell</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;foo&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>   <span class="tshl-comment">// отново няма `mut`</span>

    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> first = cell<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">borrow_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> second = cell<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">borrow_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// BOOM!</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">thread 'main' panicked at 'already borrowed: BorrowMutError', src/bin/main_45bb39151537827e2a223fcdd3995ba26df346ef.rs:9:27
note: run with `RUST_BACKTRACE=1` environment variable to display a backtrace</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="45bb39151537827e2a223fcdd3995ba26df346ef">#![allow(unused_variables)]
#![allow(unused_mut)]
use std::cell::RefCell;

fn main() {
    let cell = RefCell::new(String::from("foo"));   // отново няма `mut`

    let mut first = cell.borrow_mut();
    let mut second = cell.borrow_mut(); // BOOM!
}</pre>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>
<ul>
<li>Runtime borrow checker</li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>
<ul>
<li>Runtime borrow checker</li>
<li>помни колко immutable и mutable референции е раздал</li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>
<ul>
<li>Runtime borrow checker</li>
<li>помни колко immutable и mutable референции е раздал</li>
<li><code>borrow()</code> ще върне структура от тип <code>Ref</code>, която има deref до <code>&amp;T</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>
<ul>
<li>Runtime borrow checker</li>
<li>помни колко immutable и mutable референции е раздал</li>
<li><code>borrow()</code> ще върне структура от тип <code>Ref</code>, която има deref до <code>&amp;T</code></li>
<li><code>borrow_mut()</code> ще върне структура от тип <code>RefMut</code>, която има deref до <code>&amp;mut T</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="internal-mutability">Internal mutability</h1>
<h3 id="refcell">RefCell</h3>
<ul>
<li>Runtime borrow checker</li>
<li>помни колко immutable и mutable референции е раздал</li>
<li><code>borrow()</code> ще върне структура от тип <code>Ref</code>, която има deref до <code>&amp;T</code></li>
<li><code>borrow_mut()</code> ще върне структура от тип <code>RefMut</code>, която има deref до <code>&amp;mut T</code></li>
<li>ако не можем да вземем референция ще получим <code>panic!</code></li>
</ul>
</div><div class="slide">
<h1 id="internal-mutability">Internal mutability</h1>
<p>Често <code>Cell</code> и <code>RefCell</code> се използват в комбинация с <code>Rc</code></p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="a60e38983e0f8ae59e280e252b0025e82dc4c69c">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>cell<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">RefCell</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>rc<span class="tshl-punctuation_delimiter">::</span><span class="tshl-constructor">Rc</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> first = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">String</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">from</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;foo&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> second = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">clone</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>first<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    first<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">borrow_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">push_str</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;bar&quot;</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, second.borrow<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">foobar</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="a60e38983e0f8ae59e280e252b0025e82dc4c69c">use std::cell::RefCell;
use std::rc::Rc;

fn main() {
    let first = Rc::new(RefCell::new(String::from("foo")));
    let second = Rc::clone(&first);

    first.borrow_mut().push_str("bar");

    println!("{}", second.borrow());
}</pre>
</div><div class="slide">
<h1 id="cell-refcell">Cell, RefCell</h1>
<ul>
<li>Заобикалят "нормалните" правила, съответно ги избягвайте.</li>
</ul>
</div><div class="slide subslide">
<h1 id="cell-refcell">Cell, RefCell</h1>
<ul>
<li>Заобикалят "нормалните" правила, съответно ги избягвайте.</li>
<li>Документацията казва: "… interior mutability is something of a last resort."</li>
</ul>
</div><div class="slide subslide">
<h1 id="cell-refcell">Cell, RefCell</h1>
<ul>
<li>Заобикалят "нормалните" правила, съответно ги избягвайте.</li>
<li>Документацията казва: "… interior mutability is something of a last resort."</li>
<li>Една мъдра книжка казва: "RefCells make everything sadness."</li>
</ul>
</div><div class="slide">
<h1 id="обратно-към-rc">Обратно към Rc</h1>
<h3 id="weak-reference">Weak reference</h3>
<p>Какво правим, когато структурата ни може да има цикли?</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="0170bdd7a1ad782010f980bf6fc3761b194c9466">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">struct</span> <span class="tshl-type">TreeNode</span> {
    <span class="tshl-property">value</span>: <span class="tshl-type_builtin">u32</span>,
    <span class="tshl-property">parent</span>: <span class="tshl-type">Option</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNode</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span>,
    <span class="tshl-property">children</span>: <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNode</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span>,
}

<span class="tshl-keyword">impl</span> <span class="tshl-type">TreeNode</span> {
    <span class="tshl-keyword">fn</span> <span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">value</span>: <span class="tshl-type_builtin">u32</span>, <span class="tshl-variable_parameter">parent</span>: <span class="tshl-type">Option</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNode</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNode</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span> {
        <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">TreeNode</span> { value, parent, <span class="tshl-property">children</span>: <span class="tshl-function_macro">vec</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-punctuation_bracket">]</span> }<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>
    }
}</code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="0170bdd7a1ad782010f980bf6fc3761b194c9466">#![allow(dead_code)]
use std::rc::Rc;
use std::cell::RefCell;
//norun
struct TreeNode {
    value: u32,
    parent: Option<Rc<RefCell<TreeNode>>>,
    children: Vec<Rc<RefCell<TreeNode>>>,
}

impl TreeNode {
    fn new(value: u32, parent: Option<Rc<RefCell<TreeNode>>>) -> Rc<RefCell<TreeNode>> {
        Rc::new(RefCell::new(TreeNode { value, parent, children: vec![] }))
    }
}
fn main() {}</pre>
</div><div class="slide">
<h1 id="обратно-към-rc">Обратно към Rc</h1>
<h3 id="side-note">Side note</h3>
<p>Може да си улесните малко живота с type alias:</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="9331abd95eaa553d5912f579801e35657d25b64e">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">type</span> <span class="tshl-type">TreeNodeRef</span> = <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNode</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">struct</span> <span class="tshl-type">TreeNode</span> {
    <span class="tshl-property">value</span>: <span class="tshl-type_builtin">u32</span>,
    <span class="tshl-property">parent</span>: <span class="tshl-type">Option</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNodeRef</span><span class="tshl-punctuation_bracket">&gt;</span>,
    <span class="tshl-property">children</span>: <span class="tshl-type">Vec</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNodeRef</span><span class="tshl-punctuation_bracket">&gt;</span>,
}

<span class="tshl-keyword">impl</span> <span class="tshl-type">TreeNode</span> {
    <span class="tshl-keyword">fn</span> <span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-variable_parameter">value</span>: <span class="tshl-type_builtin">u32</span>, <span class="tshl-variable_parameter">parent</span>: <span class="tshl-type">Option</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNodeRef</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">TreeNodeRef</span> {
        <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">TreeNode</span> { value, parent, <span class="tshl-property">children</span>: <span class="tshl-function_macro">vec</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">[</span><span class="tshl-punctuation_bracket">]</span> }<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span>
    }
}</code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="9331abd95eaa553d5912f579801e35657d25b64e">#![allow(dead_code)]
use std::rc::Rc;
use std::cell::RefCell;
//norun

type TreeNodeRef = Rc<RefCell<TreeNode>>;

struct TreeNode {
    value: u32,
    parent: Option<TreeNodeRef>,
    children: Vec<TreeNodeRef>,
}

impl TreeNode {
    fn new(value: u32, parent: Option<TreeNodeRef>) -> TreeNodeRef {
        Rc::new(RefCell::new(TreeNode { value, parent, children: vec![] }))
    }
}
fn main() {}</pre>
</div><div class="slide">
<h1 id="weak-reference">Weak reference</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="43bdf9c96fdab853fe2753defd938cad239f312b">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
<span class="line-number">16</span>
<span class="line-number">17</span>
<span class="line-number">18</span>
<span class="line-number">19</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">fn</span> <span class="tshl-function">make_tree</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> -&gt; <span class="tshl-type">Rc</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">RefCell</span><span class="tshl-punctuation_bracket">&lt;</span><span class="tshl-type">TreeNode</span><span class="tshl-punctuation_bracket">&gt;</span><span class="tshl-punctuation_bracket">&gt;</span> {
    <span class="tshl-keyword">let</span> root = <span class="tshl-type">TreeNode</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">0</span>, <span class="tshl-constructor">None</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> v1 = <span class="tshl-type">TreeNode</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">1</span>, <span class="tshl-constructor">Some</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">clone</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>root<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> v2 = <span class="tshl-type">TreeNode</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">2</span>, <span class="tshl-constructor">Some</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">clone</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>root<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    {
        <span class="tshl-keyword">let</span> <span class="tshl-keyword">mut</span> r = root<span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">borrow_mut</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
        r<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">children</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">push</span><span class="tshl-punctuation_bracket">(</span>v1<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
        r<span class="tshl-punctuation_delimiter">.</span><span class="tshl-property">children</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">push</span><span class="tshl-punctuation_bracket">(</span>v2<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    }

    root
}

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> tree = <span class="tshl-function">make_tree</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, tree.borrow<span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span>.value<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    mem<span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">drop</span><span class="tshl-punctuation_bracket">(</span>tree<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">0</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="43bdf9c96fdab853fe2753defd938cad239f312b">#![allow(dead_code)]
use std::rc::Rc;
use std::cell::RefCell;
use std::mem;
#[derive(Debug)]
struct TreeNode {
value: u32,
parent: Option<Rc<RefCell<TreeNode>>>,
children: Vec<Rc<RefCell<TreeNode>>>,
}
impl TreeNode {
fn new(value: u32, parent: Option<Rc<RefCell<TreeNode>>>) -> Rc<RefCell<TreeNode>> {
Rc::new(RefCell::new(TreeNode { value, parent, children: vec![] }))
}
}
fn make_tree() -> Rc<RefCell<TreeNode>> {
    let root = TreeNode::new(0, None);
    let v1 = TreeNode::new(1, Some(Rc::clone(&root)));
    let v2 = TreeNode::new(2, Some(Rc::clone(&root)));

    {
        let mut r = root.borrow_mut();
        r.children.push(v1);
        r.children.push(v2);
    }

    root
}

fn main() {
    let tree = make_tree();
    println!("{:?}", tree.borrow().value);
    mem::drop(tree);
}</pre>
</div><div class="slide">
<h1 id="weak-reference">Weak reference</h1>
<ul>
<li>нищо не гърми, но родителя държи Rc към децата, а децата държат Rc към родителя</li>
</ul>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<ul>
<li>нищо не гърми, но родителя държи Rc към децата, а децата държат Rc към родителя</li>
<li>получаваме цикъл от референции -- никога няма да се деалокират</li>
</ul>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<ul>
<li>нищо не гърми, но родителя държи Rc към децата, а децата държат Rc към родителя</li>
<li>получаваме цикъл от референции -- никога няма да се деалокират</li>
<li>това води до изтичане на памет</li>
</ul>
</div><div class="slide">
<h1 id="weak-reference">Weak reference</h1>
<h3 id="sidenote">Sidenote</h3>
<ul>
<li>забележете, че можем да имаме memory leak в safe code</li>
</ul>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<h3 id="sidenote">Sidenote</h3>
<ul>
<li>забележете, че можем да имаме memory leak в safe code</li>
<li>затова съществува безопасната функция <code>mem::forget</code> (<a href="https://doc.rust-lang.org/std/mem/fn.forget.html#safety" target="_blank">https://doc.rust-lang.org/std/mem/fn.forget.html#safety</a>)</li>
</ul>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<h3 id="sidenote">Sidenote</h3>
<ul>
<li>забележете, че можем да имаме memory leak в safe code</li>
<li>затова съществува безопасната функция <code>mem::forget</code> (<a href="https://doc.rust-lang.org/std/mem/fn.forget.html#safety" target="_blank">https://doc.rust-lang.org/std/mem/fn.forget.html#safety</a>)</li>
<li>и затова нямаме гаранция че деструкторите ще се извикат</li>
</ul>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<h3 id="sidenote">Sidenote</h3>
<ul>
<li>забележете, че можем да имаме memory leak в safe code</li>
<li>затова съществува безопасната функция <code>mem::forget</code> (<a href="https://doc.rust-lang.org/std/mem/fn.forget.html#safety" target="_blank">https://doc.rust-lang.org/std/mem/fn.forget.html#safety</a>)</li>
<li>и затова нямаме гаранция че деструкторите ще се извикат</li>
<li>(повече за деструктори и <code>mem::drop</code> следващата седмица)</li>
</ul>
</div><div class="slide">
<h1 id="weak-reference">Weak reference</h1>
<p>Да се върнем на проблема с дървото</p>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<p>Да се върнем на проблема с дървото</p>
<ul>
<li>искаме родителят да е собственик на децата</li>
</ul>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<p>Да се върнем на проблема с дървото</p>
<ul>
<li>искаме родителят да е собственик на децата</li>
<li>не искаме детето да е собственик на родителя</li>
</ul>
</div><div class="slide subslide">
<h1 id="weak-reference">Weak reference</h1>
<p>Да се върнем на проблема с дървото</p>
<ul>
<li>искаме родителят да е собственик на децата</li>
<li>не искаме детето да е собственик на родителя</li>
<li>за това се използват силни и слаби референции</li>
</ul>
</div><div class="slide">
<h1 id="weak-reference">Weak reference</h1>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="f2ae039d29f9648d10e58b44c81dfa39c0c89791">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>mem<span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">use</span> std<span class="tshl-punctuation_delimiter">::</span>rc<span class="tshl-punctuation_delimiter">::</span>{<span class="tshl-constructor">Rc</span>, <span class="tshl-constructor">Weak</span>}<span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">fn</span> <span class="tshl-function">main</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span> {
    <span class="tshl-keyword">let</span> rc = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-constant_builtin">10</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-keyword">let</span> weak = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">downgrade</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>rc<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>

    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, <span class="tshl-constructor">Weak</span>::upgrade<span class="tshl-punctuation_bracket">(</span>&amp;weak<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Option&lt;Rc&lt;T&gt;&gt;</span>

    mem<span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">drop</span><span class="tshl-punctuation_bracket">(</span>rc<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:?}&quot;</span>, <span class="tshl-constructor">Weak</span>::upgrade<span class="tshl-punctuation_bracket">(</span>&amp;weak<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Option&lt;Rc&lt;T&gt;&gt;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">Some(10)
None</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="f2ae039d29f9648d10e58b44c81dfa39c0c89791">use std::mem;
use std::rc::{Rc, Weak};

fn main() {
    let rc = Rc::new(10);
    let weak = Rc::downgrade(&rc);

    println!("{:?}", Weak::upgrade(&weak)); // Option<Rc<T>>

    mem::drop(rc);
    println!("{:?}", Weak::upgrade(&weak)); // Option<Rc<T>>
}</pre>
</div><div class="slide">
<h1 id="reference-counting">Reference counting</h1>
<h3 id="weak-references">Weak references</h3>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
<span class="line-number">14</span>
<span class="line-number">15</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> gosho_source = <span class="tshl-string">&quot;Гошо, Гошо, скочи лошо&quot;</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> shared_gosho = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span>gosho_source<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// shared_gosho { strong = 1, weak = 0 };</span>

<span class="tshl-keyword">let</span> bratcheda = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">clone</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>shared_gosho<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// shared_gosho { strong = 2, weak = 0 };</span>
<span class="tshl-comment">// или, shared_gosho.clone(), но първото е по-ясно</span>

<span class="tshl-keyword">let</span> slabichko = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">downgrade</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>shared_gosho<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// shared_gosho { strong = 2, weak = 1 };</span>
<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:#?}&quot;</span>, <span class="tshl-constructor">Weak</span>::upgrade<span class="tshl-punctuation_bracket">(</span>&amp;slabichko<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// =&gt; Some(&quot;Гошо, Гошо, скочи лошо&quot;)</span>
                                              <span class="tshl-comment">// shared_gosho { strong = 3, weak = 1 };</span>
                                              <span class="tshl-comment">// shared_gosho { strong = 2, weak = 1 };</span>

std<span class="tshl-punctuation_delimiter">::</span>mem<span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">drop</span><span class="tshl-punctuation_bracket">(</span>bratcheda<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// shared_gosho { strong = 1, weak = 1 };</span>
std<span class="tshl-punctuation_delimiter">::</span>mem<span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">drop</span><span class="tshl-punctuation_bracket">(</span>shared_gosho<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// shared_gosho { strong = 0, weak = 1 }; =&gt; DROP!</span>

<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:#?}&quot;</span>, <span class="tshl-constructor">Weak</span>::upgrade<span class="tshl-punctuation_bracket">(</span>&amp;slabichko<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// =&gt; None</span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="rc">Rc</h1>

                <div class="code-block">
                    
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-comment">// Инициализираме споделената стойност</span>
<span class="tshl-keyword">let</span> gosho_source = <span class="tshl-string">&quot;Гошо, Гошо, скочи лошо&quot;</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> shared_gosho = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">new</span><span class="tshl-punctuation_bracket">(</span>gosho_source<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Rc&lt;&amp;str&gt;</span>

<span class="tshl-keyword">let</span> bratcheda = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">clone</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>shared_gosho<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Rc&lt;&amp;str&gt;</span>

<span class="tshl-keyword">let</span> slabichko = <span class="tshl-type">Rc</span><span class="tshl-punctuation_delimiter">::</span><span class="tshl-function">downgrade</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span>shared_gosho<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Weak&lt;&amp;str&gt;</span>
<span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{:#?}&quot;</span>, <span class="tshl-constructor">Weak</span>::upgrade<span class="tshl-punctuation_bracket">(</span>&amp;slabichko<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span> <span class="tshl-comment">// Option&lt;Rc&lt;&amp;str&gt;&gt;</span></code></pre>
                    </div>
                    
                </div>
                
</div><div class="slide">
<h1 id="rc">Rc</h1>
<p><img src="resources/rc.png" /></p>
</div><div class="slide">
<h1 id="интересни-пакети">Интересни пакети</h1>
<ul>
<li>Rcstruct: <a href="https://github.com/felixrabe/rcstruct" target="_blank">https://github.com/felixrabe/rcstruct</a></li>
<li>OnceCell: <a href="https://github.com/matklad/once_cell" target="_blank">https://github.com/matklad/once_cell</a></li>
</ul>
</div><div class="slide">
<h1 id="raw-pointers">Raw pointers</h1>
<p>Ок, нека видим и как изглеждат указателите</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="6ed329885f7bcf4fa1386cb30141e58efe303ce7">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> raw_const_ptr: <span class="tshl-operator">*</span><span class="tshl-keyword">const</span> <span class="tshl-type_builtin">u32</span> = <span class="tshl-operator">&amp;</span><span class="tshl-constant_builtin">1_u32</span> <span class="tshl-operator">as</span> <span class="tshl-operator">*</span><span class="tshl-keyword">const</span> <span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> raw_mut_ptr: <span class="tshl-operator">*</span><span class="tshl-keyword">mut</span> <span class="tshl-type_builtin">u32</span> = <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-constant_builtin">1_u32</span> <span class="tshl-operator">as</span> <span class="tshl-operator">*</span><span class="tshl-keyword">mut</span> <span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-comment">// Coercion</span>
<span class="tshl-keyword">let</span> raw_const_ptr: <span class="tshl-operator">*</span><span class="tshl-keyword">const</span> <span class="tshl-type_builtin">u32</span> = <span class="tshl-operator">&amp;</span><span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> raw_mut_ptr: <span class="tshl-operator">*</span><span class="tshl-keyword">mut</span> <span class="tshl-type_builtin">u32</span> = <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    
                </div>
                
<pre class="rustc-source" data-sha="6ed329885f7bcf4fa1386cb30141e58efe303ce7">#![allow(dead_code)]
#![allow(unused_variables)]
fn main() {
let raw_const_ptr: *const u32 = &1_u32 as *const u32;
let raw_mut_ptr: *mut u32 = &mut 1_u32 as *mut u32;

// Coercion
let raw_const_ptr: *const u32 = &1;
let raw_mut_ptr: *mut u32 = &mut 1;
}</pre>
</div><div class="slide">
<h1 id="raw-pointers">Raw pointers</h1>
<p>Първо и най-важно правило - указателите са safe, докато не се опитаме да четем или пишем в тях</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="f454cac8dfb0cd6742bcefae12515a892f302a14">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
<span class="line-number">2</span>
<span class="line-number">3</span>
<span class="line-number">4</span>
<span class="line-number">5</span>
<span class="line-number">6</span>
<span class="line-number">7</span>
<span class="line-number">8</span>
<span class="line-number">9</span>
<span class="line-number">10</span>
<span class="line-number">11</span>
<span class="line-number">12</span>
<span class="line-number">13</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-keyword">let</span> raw_const_ptr: <span class="tshl-operator">*</span><span class="tshl-keyword">const</span> <span class="tshl-type_builtin">u32</span> = <span class="tshl-operator">&amp;</span><span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span>
<span class="tshl-keyword">let</span> raw_mut_ptr: <span class="tshl-operator">*</span><span class="tshl-keyword">mut</span> <span class="tshl-type_builtin">u32</span> = <span class="tshl-operator">&amp;</span><span class="tshl-keyword">mut</span> <span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span>

<span class="tshl-keyword">unsafe</span> {
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, *raw_const_ptr<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}

<span class="tshl-comment">// За разлика от референциите, указателите</span>
<span class="tshl-comment">// могат да са null или dangling pointers</span>
<span class="tshl-keyword">unsafe</span> {
    <span class="tshl-operator">*</span>raw_mut_ptr += <span class="tshl-constant_builtin">1</span><span class="tshl-punctuation_delimiter">;</span>
    <span class="tshl-function_macro">println</span><span class="tshl-function_macro">!</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-string">&quot;{}&quot;</span>, *raw_mut_ptr<span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span>
}</code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs">1
2</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="f454cac8dfb0cd6742bcefae12515a892f302a14">fn main() {
let raw_const_ptr: *const u32 = &1;
let raw_mut_ptr: *mut u32 = &mut 1;

unsafe {
    println!("{}", *raw_const_ptr);
}

// За разлика от референциите, указателите
// могат да са null или dangling pointers
unsafe {
    *raw_mut_ptr += 1;
    println!("{}", *raw_mut_ptr);
}
}</pre>
</div><div class="slide">
<h1 id="raw-pointers">Raw pointers</h1>
<p>Нямат Deref и DerefMut. Тук компилатора си има само вградения оператор за това.</p>

                <div class="code-block">
                    <button type="button" class="btn rustc-copy" data-sha="a8c848ea06ad2b67e0c50e5c33a165c61f58c8ce">Copy</button>
                    <div class="code-container">
                        <div class="line-numbers hljs"><span class="line-number">1</span>
</div>
                        <pre><code class="rustrust language-rust hljs"><span class="tshl-punctuation_bracket">(</span><span class="tshl-operator">&amp;</span><span class="tshl-constant_builtin">1</span> <span class="tshl-operator">as</span> <span class="tshl-operator">*</span><span class="tshl-keyword">const</span> <span class="tshl-type_builtin">u32</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">.</span><span class="tshl-function_method">deref</span><span class="tshl-punctuation_bracket">(</span><span class="tshl-punctuation_bracket">)</span><span class="tshl-punctuation_delimiter">;</span></code></pre>
                    </div>
                    <div class="rustc-container">
                    <pre><div class="rustc hljs"><span style="font-weight:bold;color:rgb(255,85,85)">error[E0599]</span><span style="font-weight:bold">: no method named `deref` found for raw pointer `*const u32` in the current scope</span>
 <span style="font-weight:bold;color:rgb(85,85,255)">--&gt; </span>src/bin/main_a8c848ea06ad2b67e0c50e5c33a165c61f58c8ce.rs:2:20
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
<span style="font-weight:bold;color:rgb(85,85,255)">2</span> <span style="font-weight:bold;color:rgb(85,85,255)">| </span>(&amp;1 as *const u32).deref();
  <span style="font-weight:bold;color:rgb(85,85,255)">| </span>                   <span style="font-weight:bold;color:rgb(255,85,85)">^^^^^</span> <span style="font-weight:bold;color:rgb(255,85,85)">method not found in `*const u32`</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">|</span>
  <span style="font-weight:bold;color:rgb(85,85,255)">= </span><span style="font-weight:bold">note</span>: try using `&lt;*const T&gt;::as_ref()` to get a reference to the type behind the pointer: https://doc.rust-lang.org/std/primitive.pointer.html#method.as_ref
  <span style="font-weight:bold;color:rgb(85,85,255)">= </span><span style="font-weight:bold">note</span>: using `&lt;*const T&gt;::as_ref()` on a pointer which is unaligned or points to invalid or uninitialized memory is undefined behavior

<span style="font-weight:bold">For more information about this error, try `rustc --explain E0599`.</span>
<span style="font-weight:bold;color:rgb(255,85,85)">error</span><span style="font-weight:bold">:</span> could not compile `rust` due to previous error</div></pre>
                </div>
                </div>
                
<pre class="rustc-source" data-sha="a8c848ea06ad2b67e0c50e5c33a165c61f58c8ce">fn main() {
(&1 as *const u32).deref();
}</pre>
</div><div class="slide">
<h1 id="raw-pointers">Raw pointers</h1>
<h3 id="някои-полезни-методи">Някои полезни методи</h3>
</div><div class="slide subslide">
<h1 id="raw-pointers">Raw pointers</h1>
<h3 id="някои-полезни-методи">Някои полезни методи</h3>
<ul>
<li><code>is_null(self) -&gt; bool</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="raw-pointers">Raw pointers</h1>
<h3 id="някои-полезни-методи">Някои полезни методи</h3>
<ul>
<li><code>is_null(self) -&gt; bool</code></li>
<li><code>unsafe fn as_ref&lt;'a&gt;(self) -&gt; Option&lt;&amp;'a T&gt;</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="raw-pointers">Raw pointers</h1>
<h3 id="някои-полезни-методи">Някои полезни методи</h3>
<ul>
<li><code>is_null(self) -&gt; bool</code></li>
<li><code>unsafe fn as_ref&lt;'a&gt;(self) -&gt; Option&lt;&amp;'a T&gt;</code></li>
<li><code>unsafe fn offset(self, count: isize) -&gt; *const T</code></li>
</ul>
</div><div class="slide subslide">
<h1 id="raw-pointers">Raw pointers</h1>
<h3 id="някои-полезни-методи">Някои полезни методи</h3>
<ul>
<li><code>is_null(self) -&gt; bool</code></li>
<li><code>unsafe fn as_ref&lt;'a&gt;(self) -&gt; Option&lt;&amp;'a T&gt;</code></li>
<li><code>unsafe fn offset(self, count: isize) -&gt; *const T</code></li>
<li>И други безумия тук: <a href="https://doc.rust-lang.org/std/primitive.pointer.html" target="_blank">https://doc.rust-lang.org/std/primitive.pointer.html</a></li>
</ul>
</div><div class="slide">
<h1 id="въпроси">Въпроси</h1>
</div>
    </main>
</body>
</html>
